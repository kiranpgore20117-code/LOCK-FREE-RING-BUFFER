#include <stdatomic.h>
#include <stdint.h>
#include <stdbool.h>

#define BUFFER_SIZE 1024

typedef struct {
    uint8_t buffer[BUFFER_SIZE];
    _Atomic uint32_t head;
    _Atomic uint32_t tail;
    const uint32_t size;
} ring_buffer_t;

bool ring_buffer_init(ring_buffer_t *rb) {
    rb->head = 0;
    rb->tail = 0;
    rb->size = BUFFER_SIZE;
    return true;
}

bool ring_buffer_enqueue(ring_buffer_t *rb, uint8_t data) {
    uint32_t current_head = atomic_load(&rb->head);
    uint32_t next_head = (current_head + 1) % rb->size;

    if (next_head == atomic_load(&rb->tail)) {
        return false;
    }

    rb->buffer[current_head] = data;
    atomic_thread_fence(memory_order_release);
    atomic_store(&rb->head, next_head);

    return true;
}

bool ring_buffer_dequeue(ring_buffer_t *rb, uint8_t *data) {
    uint32_t current_tail = atomic_load(&rb->tail);

    if (current_tail == atomic_load(&rb->head)) {
        return false;
    }

    *data = rb->buffer[current_tail];
    atomic_thread_fence(memory_order_acquire);
    atomic_store(&rb->tail, (current_tail + 1) % rb->size);

    return true;
}
